<html lang="pt-br">
  <head>
    <title>bookmak</title>
    <!--Meta Tags-->
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Bootstrap CSS-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/checkout.css" />
  </head>
  <style>
    .book-cover {
      width: 100px;
      height: 150px;
      object-fit: cover;
    }
  </style>
  <body>
    <!--Header-->
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a href="/" class="navbar-brand">Bookmak</a>
        </div>
      </nav>
    </header>
    <!--Conteudo-->
    <main class="container mb-5">
      <h1 class="mt-3 text-center">Detalhes do Pedido</h1>

      <div class="mt-3 border p-3">
        <h5>
          ID:
          <%= order.id %>
        </h5>
        <h5>Status:</h5>
        <% const ordenatedStatus = orderUpdates(order.updates) %>
        <% const lastStatus = ordenatedStatus[0] %>
        <p class="mt-0 status"><%= formatOrderStatus(lastStatus.status) %></p>
        <h5>Histórico</h5>
        <p class="mt-0 statusObs">
          <% ordenatedStatus.forEach((status) => { %>
          <%- formatTimestamp(status.timestamp) %> -
          <%- formatOrderStatus(status.status) %> - 
          <%- status.observations %><br/>
          <% }) %>
        </p>
        
        <div class="d-flex justify-content-between">
          <%- lastStatus.status === OrderStatusEnum.PROCESSING ? `
          <a href="/admin/order/${order.id}/aprovePayment" class="btn btn-outline-secondary mt-2 aprovePayment">Pagamento Recebido</a>
          <a href="/admin/order/${order.id}/rejectPayment" class="btn btn-outline-secondary mt-2 rejectPayment">Recusar Pagamento</a>
          ` : '' %>
          <%- lastStatus.status === OrderStatusEnum.EXCHANGING ? `
          <a href="/admin/order/${order.id}/aproveExchange" class="btn btn-outline-secondary mt-2 aproveExchange">Trocar Pedido</a>
          <a href="/admin/order/${order.id}/rejectExchange" class="btn btn-outline-secondary mt-2 rejectExchange">Cancelar Troca</a>
          ` : '' %>
          <%- lastStatus.status === OrderStatusEnum.PAYMENT_APPROVED ? `
          <a href="/admin/order/${order.id}/startPreparing" class="btn btn-outline-secondary mt-2 startPreparing">Iniciar Preparação</a>
          ` : '' %>
          <%- lastStatus.status === OrderStatusEnum.PREPARING ? `
          <a href="/admin/order/${order.id}/sendOrder" class="btn btn-outline-secondary mt-2 sendOrder">Enviar Pedido</a>
          ` : '' %>
          <%- lastStatus.status === OrderStatusEnum.SENDING ? `
          <a href="/admin/order/${order.id}/sendedOrder" class="btn btn-outline-secondary mt-2 sendedOrder">Confirmar Entrega</a>
          ` : '' %>
        </div>
      
      </div>
      <!--Lista de Produtos-->
      <ul class="list-group mt-3 border p-3">
        <h5>Lista de Produtos:</h5>
        <% order.items.forEach((item) => { %>
          <li class="list-group-item d-flex align-items-center border-0">
            <img
              src="<%= item.sku.cover %>"
              alt="<%= item.sku.title %>"
              class="me-3 book-cover cursor-pointer"
              role="button"
            />
            <div class="d-flex flex-column">
              <h6 class="fw-bold"><%- item.sku.title %></h6>
              <p>Autor: <%- formatAuthors(item.sku.book.authors) %></p>
              <p>
                Preço Unitário: <%= formatPrice(item.unitSellPrice) %>
                <br />Quantidade:
                <%- item.quantity %>
                <br />Subtotal:
                <%= formatPrice(item.unitSellPrice * item.quantity) %>
              </p>
            </div>
          </li>
        <% }) %>
      </ul>
      <!--Dados do Cliente-->
      <div class="mt-3 border p-3">
        <h5>Dados do Cliente:</h5>
        <div class="row">
          <div class="col-7 name">Nome: <%= order.customer.name %></div>
          <div class="col-5 email">Email: <%= order.customer.email %></div>
          <div class="col-7 cpf">CPF: <%= maskCPF(order.customer.cpf) %></div>
          <div class="col-5 dateOfBirth">
            Data de Nascimento: <%= maskDate(order.customer.dateOfBirth) %>
          </div>
        </div>
      </div>
      <!--Endereço de Envio e Cobrança-->
      <div class="mt-3 border p-3">
        <h5 class="deliveryAddressNickname">
          Endereço de Envio: <%- order.shippingAddress.nickname %>
        </h5>
        <p class="deliveryAddress">
          <%= maskAddresss(order.shippingAddress) %><br />
          Observações:
          <%- order.shippingAddress.observations %>
        </p>
        <h5 class="billingAddressNickname">
          Endereço de Cobrança: <%- order.billingAddress.nickname %>
        </h5>
        <p class="billingAddress">
          <%= maskAddresss(order.billingAddress) %><br />
          Observações:
          <%- order.billingAddress.observations %>
        </p>
      </div>
      <!--<Marca Página-->
      <div class="mt-3 border p-3">
        <h5>Marca Página Personalizado:</h5>
        <p>
          <b>Estilo:</b> <%- order.bookmarkStyle %><br/>
          <b>Texto:</b>Texto: <%- order.bookmarkText %>
        </p>
      </div>
      <!--Cupom-->
      <div class="mt-3 border p-3">
        <h5>Cupons:</h5>

        <div class="row">
          <div class="mb-0 d-flex justify-content-between">
            <% order.usedPaymentMethods.filter((paymentMethod) => paymentMethod.coupon != null).forEach((paymentMethod) => { %>
              <p class="mb-0"><%- paymentMethod.coupon.code %>  (<%- formatPrice(paymentMethod.value*-1) %>)</p>
            <% }) %>
          </div>
        </div>
      </div>
      <!--Resumo-->
      <div class="mt-3 border p-3 sumarizer">
        <h5>Resumo:</h5>
        <div class="row">
          <div class="col-6">Subtotal</div>
          <div class="col-6 text-end subtotal">
            <%- formatPrice(order.subtotal) %>
          </div>
          <div class="col-6">Frete</div>
          <div class="col-6 text-end shippingPrice">
            <%- formatPrice(order.shippingPrice) %>
          </div>
          <div class="col-6">Desconto</div>
          <div class="col-6 text-end discount">
            <%- formatPrice(order.discounts*-1) %>
          </div>
          <div class="col-6">Total</div>
          <div class="col-6 text-end totalPrice">
            <%- formatPrice(order.totalPrice) %>
          </div>
        </div>
        </div>
      </div>
      <!--Pagamento-->
      <div class="mt-3 border p-3">
        <h5>Pagamento:</h5>
        <p class="mb-0 card">
          <% order.usedPaymentMethods.forEach((paymentMethod) => { %>
            <% if(paymentMethod.card !== null) { %>
              <%= formatCardNumber(paymentMethod.card.number) %> - <%= formatCardFlag(paymentMethod.card.flag) %> - <%= formatPrice(paymentMethod.value) %><br/>
            <% } %>
          <% }) %>
        </p>
      </div>
    </main>
    <!--Bootstrap JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
